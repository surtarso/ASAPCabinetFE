id: io.asapcabinetfe.ASAPCabinetFE
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk

sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable

command: ASAPCabinetFE

finish-args:
  - --share=network
  - --share=ipc
  - --device=dri
  - --filesystem=host
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Flatpak
  - --system-talk-name=org.freedesktop.login1
  - --env=SDL_JOYSTICK_WGI=1

cleanup:
  - /include
  - '*.la'
  - '*.a'

modules:
  - name: zstd   # zstd dependency for libzip
    buildsystem: simple
    build-commands:
      - make
      - make install PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/facebook/zstd/archive/refs/tags/v1.5.7.tar.gz
        sha256: 37d7284556b20954e56e1ca85b80226768902e2edabd3b649e9e72c0c9012ee3

  - name: asapcabinetfe  # main app
    buildsystem: simple

    build-options:
      env:
        - FLATPAK_BUILD=1
        - CARGO_HOME=/run/build/.cargo
        - RUSTUP_HOME=/run/build/.rustup
        - PATH=/app/bin:/usr/lib/sdk/rust-stable/bin:/usr/bin

    config-opts:
      - -DCMAKE_BUILD_TYPE=Release

    sources:
      - type: dir
        path: ../../ASAPCabinetFE

      # - type: git
      #   url: https://github.com/surtarso/ASAPCabinetFE.git
      #   tag: v1.2.15

      # cmake FetchContent sources mirror
      - type: file  # pugixml
        url: https://github.com/zeux/pugixml/releases/download/v1.15/pugixml-1.15.tar.gz
        sha256: 655ade57fa703fb421c2eb9a0113b5064bddb145d415dd1f88c79353d90d511a

      - type: file  # rapidfuzz-cpp
        url: https://github.com/rapidfuzz/rapidfuzz-cpp/archive/refs/tags/v3.3.3.tar.gz
        sha256: fa0fbd40110df8134cf05bddbaa4e237dbc4fd915ab9a3029ff481a8d3e8b757

      - type: file  # ImGui
        url: https://github.com/ocornut/imgui/archive/refs/tags/v1.92.4.tar.gz
        sha256: 0e175d4d941112532549b418ced0bd546abe9024ecb9b5f431f8a67a2197b0ba

      - type: file  # ImGuiFileDialog
        url: https://github.com/aiekick/ImGuiFileDialog/archive/refs/tags/v0.6.8.tar.gz
        sha256: 7aa3fbb0fc7206c5b434246d906f036057a59eb51e28ae36488aa654a667a266

      - type: file
        path: rust-vendor.tar.gz
        sha256: c896ffc30b0a572f62589cd71da50c6f4c1712465c3af8bc2056aaa15befa494

      - type: file  # vpin crate
        url: https://github.com/francisdb/vpin/archive/refs/tags/v0.18.6.tar.gz
        sha256: 0d79288f6ac3adc8a5dc4bf8ae60cf06ccad1d1beede9e8c51f0fb8e3581a3b6

      - type: file
        url: https://github.com/nlohmann/json/archive/refs/tags/v3.12.0.tar.gz
        sha256: 4b92eb0c06d10683f7447ce9406cb97cd4b453be18d7279320f7b2f025c10187

      - type: file
        url: https://libzip.org/download/libzip-1.11.4.tar.gz
        sha256: 82e9f2f2421f9d7c2466bbc3173cd09595a88ea37db0d559a9d0a2dc60dc722e

    build-commands:
      # --- 1. INITIALIZE BUILD AND GENERATE CARGO.TOML ---
      - export DBUS_SESSION_BUS_ADDRESS=unix:path=/dev/null ; cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/app

      # requires rust-vendor.tar.gz (vpin crate dependencies)
      # - in flatpak/ folder:
      # - cp -var ../src/vpin_ffi_wrapper/src/ .
      # - cargo vendor --manifest-path Cargo.toml
      # - tar czf rust-vendor.tar.gz vendor/
      # - sha256sum rust-vendor.tar.gz

      # --- 2. EXTRACT VENDOR DIRECTORY ---
      - tar xzf rust-vendor.tar.gz

      # --- 3. CARGO CONFIGURATION SETUP (Use Vendor) ---
      - mkdir -p .cargo
      - echo '[net]' > .cargo/config.toml
      - echo 'retry = 5' >> .cargo/config.toml

      - echo '' >> .cargo/config.toml
      - echo '[source.crates-io]' >> .cargo/config.toml
      - echo 'replace-with = "vendored-sources"' >> .cargo/config.toml
      - echo '' >> .cargo/config.toml
      - echo '[source.vendored-sources]' >> .cargo/config.toml
      - echo 'directory = "vendor"' >> .cargo/config.toml

      # --- 4. FINISH STAGING (Copy Source Files) ---
      - cmake -E copy_directory src/vpin_ffi_wrapper/src _deps/vpin_ffi_wrapper-build/src
      - cmake -E copy_directory src/vpin_ffi_wrapper/include _deps/vpin_ffi_wrapper-build/include

      # 5. RUN CARGO FETCH (uses vendored sources) and MAKE
      - export DBUS_SESSION_BUS_ADDRESS=unix:path=/dev/null ; cargo fetch --manifest-path _deps/vpin_ffi_wrapper-build/Cargo.toml

      - export DBUS_SESSION_BUS_ADDRESS=unix:path=/dev/null ; make -j$(nproc)
      - make install

    post-install:
      - install -Dm644 flatpak/io.asapcabinetfe.ASAPCabinetFE.svg /app/share/icons/hicolor/scalable/apps/io.asapcabinetfe.ASAPCabinetFE.svg

      - desktop-file-install --dir=/app/share/applications/ flatpak/io.asapcabinetfe.ASAPCabinetFE.desktop

      - install -Dm644 flatpak/io.asapcabinetfe.ASAPCabinetFE.metainfo.xml /app/share/metainfo/io.asapcabinetfe.ASAPCabinetFE.metainfo.xml
