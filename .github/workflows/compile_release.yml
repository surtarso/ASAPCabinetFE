name: latest build

on:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/compile_release.yml"
      - "src/**"
      - "CMakeLists.txt"
      - "external/**"
      - "version.h.in"
      - "apt-packages.txt"
      - "pacman-packages.txt"
      - "Doxyfile"
      - "docs/**"
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to rebuild (e.g. v1.2.8)"
        required: true

permissions:
  actions: read
  contents: write
  id-token: write
  security-events: write

jobs:
#============= UBUNTU BUILD JOB ===============
  build_ubuntu:
    runs-on: ubuntu-latest
    outputs:
      sdl2_version: ${{ steps.get-lib-versions.outputs.sdl2_version }}
      ffmpeg_version: ${{ steps.get-lib-versions.outputs.ffmpeg_version }}
      vlc_version: ${{ steps.get-lib-versions.outputs.vlc_version }}
      curl_version: ${{ steps.get-lib-versions.outputs.curl_version }}
      glibc_version: ${{ steps.get-lib-versions.outputs.glibc_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout selected tag
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        git fetch --tags
        git checkout ${{ inputs.tag }}

    # Install dependencies
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install findutils apt-utils git -y -qq
        git config --global --add safe.directory "${GITHUB_WORKSPACE}"
        cat apt-packages.txt | xargs sudo apt-get install -y -qq

    - name: Get Library Versions for Release Tag
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      id: get-lib-versions
      run: |
        SDL2_VER=$(pkg-config --modversion sdl2 || echo "N/A")
        FFMPEG_VER=$(pkg-config --modversion libavcodec || echo "N/A")
        VLC_VER=$(pkg-config --modversion libvlc || echo "N/A")
        CURL_VER=$(pkg-config --modversion libcurl || echo "N/A")
        GLIBC_VER=$(ldd --version 2>&1 | head -n 1 | awk '{print $NF}' || echo "N/A")
        echo "sdl2_version=$SDL2_VER" >> $GITHUB_OUTPUT
        echo "ffmpeg_version=$FFMPEG_VER" >> $GITHUB_OUTPUT
        echo "vlc_version=$VLC_VER" >> $GITHUB_OUTPUT
        echo "curl_version=$CURL_VER" >> $GITHUB_OUTPUT
        echo "glibc_version=$GLIBC_VER" >> $GITHUB_OUTPUT

    # Configure and build
    - name: Configure with CMake
      run: |
        mkdir -p "${GITHUB_WORKSPACE}/build"
        cd "${GITHUB_WORKSPACE}/build"
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${GITHUB_WORKSPACE}/install_root -S .. -B .
    - name: Compile with CMake
      run: |
        cd "${GITHUB_WORKSPACE}/build"
        cmake --build . -j$(nproc)

    # Install and package
    - name: Run `make install` for packaging
      run: |
        cd "${GITHUB_WORKSPACE}/build"
        cmake --install .

    - name: Create distributable archive
      id: create-archive
      run: |
        VERSION=$(git describe --tags --always --dirty="-dirty" --abbrev=7)
        if [ -z "$VERSION" ]; then
            VERSION="unknown-$(date +%Y%m%d%H%M%S)"
        fi
        TARBALL_NAME="ASAPCabinetFE-${VERSION}-ubuntu-x64.tar.gz"
        ARTIFACT_TEMP_DIR="${RUNNER_TEMP}/artifacts"
        mkdir -p "${ARTIFACT_TEMP_DIR}"
        TARBALL_FULL_PATH="${ARTIFACT_TEMP_DIR}/${TARBALL_NAME}"
        cd "${HOME}/ASAPCabinetFE"
        tar -czvhf "${TARBALL_FULL_PATH}" ./*
        echo "tarball_name=${TARBALL_NAME}" >> "$GITHUB_OUTPUT"
        echo "tarball_full_path=${TARBALL_FULL_PATH}" >> "$GITHUB_OUTPUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ASAPCabinetFE-ubuntu-x64
        path: "${{ runner.temp }}/artifacts/${{ steps.create-archive.outputs.tarball_name }}"
        retention-days: 7

    - name: Test Version Flag
      run: |
        cd "${HOME}/ASAPCabinetFE"
        VERSION_OUTPUT=$(./ASAPCabinetFE --version)
        if echo "$VERSION_OUTPUT" | grep -q "ASAPCabinetFE version"; then
          echo "Version check passed: $VERSION_OUTPUT"
        else
          echo "Version check failed!"
          exit 1
        fi

#=============== ARCH BUILD JOB ===============
  build_arch:
    runs-on: ubuntu-latest
    container: archlinux/archlinux:latest
    outputs:
      sdl2_version: ${{ steps.get-lib-versions.outputs.sdl2_version }}
      ffmpeg_version: ${{ steps.get-lib-versions.outputs.ffmpeg_version }}
      vlc_version: ${{ steps.get-lib-versions.outputs.vlc_version }}
      curl_version: ${{ steps.get-lib-versions.outputs.curl_version }}
      glibc_version: ${{ steps.get-lib-versions.outputs.glibc_version }}
    steps:
    - name: Install git and git-lfs
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm --needed git git-lfs
        git lfs install
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout selected tag
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        git config --global --add safe.directory "${GITHUB_WORKSPACE}"
        git fetch --tags
        git checkout ${{ inputs.tag }}

    - name: Install System Dependencies
      run: |
        pacman -S --noconfirm --needed findutils cmake base-devel pkgconf
        git config --global --add safe.directory "${GITHUB_WORKSPACE}"
        cat pacman-packages.txt | xargs pacman -S --noconfirm --needed

    - name: Get Library Versions for Release Tag
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      id: get-lib-versions
      run: |
        SDL2_VER=$(pkg-config --modversion sdl2 || echo "N/A")
        FFMPEG_VER=$(pkg-config --modversion libavcodec || echo "N/A")
        VLC_VER=$(pkg-config --modversion libvlc || echo "N/A")
        CURL_VER=$(pkg-config --modversion libcurl || echo "N/A")
        GLIBC_VER=$(ldd --version 2>&1 | head -n 1 | awk '{print $NF}' || echo "N/A")
        echo "sdl2_version=$SDL2_VER" >> $GITHUB_OUTPUT
        echo "ffmpeg_version=$FFMPEG_VER" >> $GITHUB_OUTPUT
        echo "vlc_version=$VLC_VER" >> $GITHUB_OUTPUT
        echo "curl_version=$CURL_VER" >> $GITHUB_OUTPUT
        echo "glibc_version=$GLIBC_VER" >> $GITHUB_OUTPUT

    - name: Configure with CMake
      run: |
        mkdir -p "${GITHUB_WORKSPACE}/build"
        cd "${GITHUB_WORKSPACE}/build"
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/github/workspace/install_root -S .. -B .

    - name: Compile with CMake
      run: |
        cd "${GITHUB_WORKSPACE}/build"
        cmake --build . -j$(nproc)

    - name: Run `make install` for packaging
      run: |
        cd "${GITHUB_WORKSPACE}/build"
        cmake --install .

    - name: Create distributable archive
      id: create-archive
      run: |
        VERSION=$(git describe --tags --always --dirty="-dirty" --abbrev=7)
        if [ -z "$VERSION" ]; then
            VERSION="unknown-$(date +%Y%m%d%H%M%S)"
        fi
        TARBALL_NAME="ASAPCabinetFE-${VERSION}-archlinux-x64.tar.gz"
        ARTIFACT_TEMP_DIR="/tmp/artifacts"
        mkdir -p "${ARTIFACT_TEMP_DIR}"
        TARBALL_FULL_PATH="${ARTIFACT_TEMP_DIR}/${TARBALL_NAME}"
        cd "/github/home/ASAPCabinetFE"
        tar -czvhf "${TARBALL_FULL_PATH}" ./*
        echo "tarball_name=${TARBALL_NAME}" >> "$GITHUB_OUTPUT"
        echo "tarball_full_path=${TARBALL_FULL_PATH}" >> "$GITHUB_OUTPUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ASAPCabinetFE-archlinux-x64
        path: "${{ steps.create-archive.outputs.tarball_full_path }}"
        retention-days: 7

    - name: Test Version Flag
      run: |
        cd "/github/home/ASAPCabinetFE"
        VERSION_OUTPUT=$(./ASAPCabinetFE --version)
        if echo "$VERSION_OUTPUT" | grep -q "ASAPCabinetFE version"; then
          echo "Version check passed: $VERSION_OUTPUT"
        else
          echo "Version check failed!"
          exit 1
        fi

#=============== MACOS ARM64 BUILD JOB ===============
  build_macos_arm64:
    runs-on: macos-latest

    outputs:
      sdl2_version: ${{ steps.get-lib-versions.outputs.sdl2_version }}
      ffmpeg_version: ${{ steps.get-lib-versions.outputs.ffmpeg_version }}
      curl_version: ${{ steps.get-lib-versions.outputs.curl_version }}
      macos_version: ${{ steps.get-lib-versions.outputs.macos_version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout selected tag
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        git fetch --tags
        git checkout ${{ inputs.tag }}

    # Install dependencies using Homebrew
    - name: Install Homebrew Dependencies
      run: |
        brew update
        brew install cmake pkg-config \
          sdl2 sdl2_image sdl2_ttf sdl2_mixer \
          ffmpeg openssl@3 libzip curl nlohmann-json

    # Collect versions (for release notes)
    - name: Get Library Versions
      id: get-lib-versions
      run: |
        SDL2_VER=$(pkg-config --modversion sdl2 || echo "N/A")
        FFMPEG_VER=$(pkg-config --modversion libavcodec || echo "N/A")
        CURL_VER=$(pkg-config --modversion libcurl || echo "N/A")
        MACOS_VER=$(sw_vers -productVersion || echo "N/A")
        echo "sdl2_version=$SDL2_VER" >> $GITHUB_OUTPUT
        echo "ffmpeg_version=$FFMPEG_VER" >> $GITHUB_OUTPUT
        echo "curl_version=$CURL_VER" >> $GITHUB_OUTPUT
        echo "macos_version=$MACOS_VER" >> $GITHUB_OUTPUT

    # Configure and build
    - name: Configure with CMake
      run: |
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=${GITHUB_WORKSPACE}/install_root \
              -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
              -DCMAKE_FIND_ROOT_PATH="$(brew --prefix)" \
              -DCMAKE_OSX_ARCHITECTURES="arm64" \
              -S .. -B .

    - name: Compile with CMake
      run: |
        cd build
        cmake --build . -j$(sysctl -n hw.logicalcpu)

    - name: Run make install
      run: |
        cd build
        cmake --install .

    - name: Create distributable archive
      id: create-archive
      run: |
        VERSION=$(git describe --tags --always --dirty="-dirty" --abbrev=7)
        if [ -z "$VERSION" ]; then
            VERSION="unknown-$(date +%Y%m%d%H%M%S)"
        fi
        TARBALL_NAME="ASAPCabinetFE-${VERSION}-macos-arm64.tar.gz"
        ARTIFACT_TEMP_DIR="${RUNNER_TEMP}/artifacts"
        mkdir -p "${ARTIFACT_TEMP_DIR}"
        TARBALL_FULL_PATH="${ARTIFACT_TEMP_DIR}/${TARBALL_NAME}"
        cd "${HOME}/ASAPCabinetFE"
        tar -czvhf "${TARBALL_FULL_PATH}" ./*
        echo "tarball_name=${TARBALL_NAME}" >> "$GITHUB_OUTPUT"
        echo "tarball_full_path=${TARBALL_FULL_PATH}" >> "$GITHUB_OUTPUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ASAPCabinetFE-macos-arm64
        path: "${{ steps.create-archive.outputs.tarball_full_path }}"
        retention-days: 7

#=============== MACOS x86_64 BUILD JOB ===============
  build_macos_x86_64:
    runs-on: macos-latest

    outputs:
      sdl2_version: ${{ steps.get-lib-versions.outputs.sdl2_version }}
      ffmpeg_version: ${{ steps.get-lib-versions.outputs.ffmpeg_version }}
      curl_version: ${{ steps.get-lib-versions.outputs.curl_version }}
      macos_version: ${{ steps.get-lib-versions.outputs.macos_version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout selected tag
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        git fetch --tags
        git checkout ${{ inputs.tag }}

    - name: Set Environment for x86_64
      run: |
        echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Install Homebrew Dependencies for x86_64
      run: |
        arch -x86_64 /bin/bash -c "
        if ! command -v /usr/local/bin/brew >/dev/null 2>&1; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"
        fi
        /usr/local/bin/brew update
        /usr/local/bin/brew install cmake pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer ffmpeg openssl@3 libzip curl nlohmann-json

    # Collect versions (for release notes)
    - name: Get Library Versions
      id: get-lib-versions
      run: |
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
        SDL2_VER=$(pkg-config --modversion sdl2 || echo "N/A")
        FFMPEG_VER=$(pkg-config --modversion libavcodec || echo "N/A")
        CURL_VER=$(pkg-config --modversion libcurl || echo "N/A")
        MACOS_VER=$(sw_vers -productVersion || echo "N/A")
        echo "sdl2_version=$SDL2_VER" >> $GITHUB_OUTPUT
        echo "ffmpeg_version=$FFMPEG_VER" >> $GITHUB_OUTPUT
        echo "curl_version=$CURL_VER" >> $GITHUB_OUTPUT
        echo "macos_version=$MACOS_VER" >> $GITHUB_OUTPUT

    # Configure and build
    - name: Configure with CMake
      run: |
        export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INSTALL_PREFIX=${GITHUB_WORKSPACE}/install_root
        -DCMAKE_PREFIX_PATH="/usr/local"
        -DCMAKE_FIND_ROOT_PATH="/usr/local"
        -DCMAKE_OSX_ARCHITECTURES="x86_64"
        -S .. -B .

    - name: Compile with CMake
      run: |
        cd build
        cmake --build . -j$(sysctl -n hw.logicalcpu)

    - name: Run make install
      run: |
        cd build
        cmake --install .

    - name: Create distributable archive
      id: create-archive
      run: |
        VERSION=$(git describe --tags --always --dirty="-dirty" --abbrev=7)
        if [ -z "$VERSION" ]; then
            VERSION="unknown-$(date +%Y%m%d%H%M%S)"
        fi
        TARBALL_NAME="ASAPCabinetFE-${VERSION}-macos-x86_64.tar.gz"
        ARTIFACT_TEMP_DIR="${RUNNER_TEMP}/artifacts"
        mkdir -p "${ARTIFACT_TEMP_DIR}"
        TARBALL_FULL_PATH="${ARTIFACT_TEMP_DIR}/${TARBALL_NAME}"
        cd "${HOME}/ASAPCabinetFE"
        tar -czvhf "${TARBALL_FULL_PATH}" ./*
        echo "tarball_name=${TARBALL_NAME}" >> "$GITHUB_OUTPUT"
        echo "tarball_full_path=${TARBALL_FULL_PATH}" >> "$GITHUB_OUTPUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ASAPCabinetFE-macos-x86_64
        path: "${{ steps.create-archive.outputs.tarball_full_path }}"
        retention-days: 7

#=============== RELEASE JOB ================
  release:
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [build_ubuntu, build_arch, build_macos_arm64, build_macos_x86_64, codeql_analysis]
    steps:
    - name: Download Ubuntu artifact
      uses: actions/download-artifact@v4
      with:
        name: ASAPCabinetFE-ubuntu-x64
        path: artifacts/ubuntu

    - name: Download Arch artifact
      uses: actions/download-artifact@v4
      with:
        name: ASAPCabinetFE-archlinux-x64
        path: artifacts/arch

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ASAPCabinetFE Release ${{ github.ref_name }}
        body: |
          ### _As Simple As Possible Cabinet Front-End_ release ${{ github.ref_name }}

          Unpack and run `./ASAPCabinetFE` or `./ASAPCabinetFE-Editor`
          Please refer to the [User's Manual](https://github.com/surtarso/ASAPCabinetFE/blob/main/UsersManual.md)

          **Changes**:
            -

          **Fixes**:
            -

          **Known bugs**:
            -

          <details>
          <summary>Ubuntu/Debian build compiled using...</summary>

          - GLIBC: ${{ needs.build_ubuntu.outputs.glibc_version }}
          - SDL2: ${{ needs.build_ubuntu.outputs.sdl2_version }}
          - FFmpeg: ${{ needs.build_ubuntu.outputs.ffmpeg_version }}
          - VLC: ${{ needs.build_ubuntu.outputs.vlc_version }}
          - cURL: ${{ needs.build_ubuntu.outputs.curl_version }}

          </details>

          <details>
          <summary>Arch build compiled using...</summary>

          - GLIBC: ${{ needs.build_arch.outputs.glibc_version }}
          - SDL2: ${{ needs.build_arch.outputs.sdl2_version }}
          - FFmpeg: ${{ needs.build_arch.outputs.ffmpeg_version }}
          - VLC: ${{ needs.build_arch.outputs.vlc_version }}
          - cURL: ${{ needs.build_arch.outputs.curl_version }}

          </details>

          <details>
          <summary>macOS arm64 build compiled using...</summary>

          - macOS: ${{ needs.build_macos_arm64.outputs.macos_version }}
          - SDL2: ${{ needs.build_macos_arm64.outputs.sdl2_version }}
          - FFmpeg: ${{ needs.build_macos_arm64.outputs.ffmpeg_version }}
          - cURL: ${{ needs.build_macos_arm64.outputs.curl_version }}

          </details>

          **Full Changelog**: https://github.com/surtarso/ASAPCabinetFE/commits/${{ github.ref_name }}
        draft: true
        prerelease: false
        files: |
          artifacts/ubuntu/*.tar.gz
          artifacts/arch/*.tar.gz
          artifacts/macos-arm64/*.tar.gz
          artifacts/macos-x86_64/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout repo for latest_version.txt update
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
        lfs: false

    - name: Update latest_version.txt
      run: |
        echo "${GITHUB_REF_NAME}" > latest_version.txt
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add latest_version.txt
        git commit -m "Update latest_version.txt for release ${GITHUB_REF_NAME} [skip ci]"
        git push origin main


#=============== DOXYGEN JOB ================
  doxygen_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Install Doxygen and Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install doxygen graphviz pdf2svg -y

    - name: Generate Doxygen documentation
      run: doxygen Doxyfile

    - name: Create .nojekyll file
      run: touch docs/html/.nojekyll

    - name: Upload documentation artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/html

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4

#=============== CODEQL JOB =================
  codeql_analysis:
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [build_ubuntu, build_arch]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    # Install dependencies
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install findutils apt-utils git -y -qq
        git config --global --add safe.directory "${GITHUB_WORKSPACE}"
        cat apt-packages.txt | xargs sudo apt-get install -y -qq

    # Initialize CodeQL before build
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: cpp

    # Configure and build
    - name: Configure with CMake
      run: |
        mkdir -p "${GITHUB_WORKSPACE}/build"
        cd "${GITHUB_WORKSPACE}/build"
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${GITHUB_WORKSPACE}/install_root -S .. -B .

    - name: Compile with CMake
      run: |
        cd "${GITHUB_WORKSPACE}/build"
        cmake --build . -j$(nproc)

    # Run CodeQL analysis
    - name: Run CodeQL analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:cpp"
